<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GlassMeet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --surface: #1e1e1e;
            --surface-hover: #2c2c2c;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --danger: #cf6679;
            --text-main: #ffffff;
            --text-sec: #b0b0b0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .screen { display: none; flex: 1; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* HERO & LOBBY */
        #home-screen { align-items: center; justify-content: center; background: radial-gradient(circle at top, #2c2c2c 0%, #121212 100%); padding: 20px; }
        .hero-card { background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(20px); padding: 40px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); max-width: 400px; width: 100%; text-align: center; }
        .hero-btn { background: linear-gradient(135deg, var(--primary), #9955e8); color: #000; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; }
        .code-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 12px; font-size: 16px; text-align: center; }
        .join-code-btn { background: var(--surface-hover); color: var(--primary); border: 1px solid var(--primary); padding: 0 20px; border-radius: 12px; cursor: pointer; }

        #lobby-screen { align-items: center; justify-content: center; }
        .lobby-container { width: 100%; max-width: 500px; padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .preview-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; overflow: hidden; position: relative; }
        .preview-box video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .preview-avatar { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #1e1e1e; z-index: 2; }
        .preview-avatar img { width: 120px; height: 120px; border-radius: 50%; }
        .preview-controls { position: absolute; bottom: 15px; left: 0; right: 0; display: flex; justify-content: center; gap: 15px; z-index: 5; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .circle-btn.off { background: var(--danger); }
        .form-input { width: 100%; background: var(--surface); border: 1px solid #333; color: white; padding: 14px; border-radius: 12px; font-size: 16px; outline: none; }

        /* MEETING */
        #meeting-screen { position: relative; }
        #video-grid { flex: 1; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 10px; padding: 10px; padding-bottom: 100px; overflow-y: auto; }
        
        .vid-card { position: relative; background: #1e1e1e; border-radius: 12px; overflow: hidden; aspect-ratio: 16/9; flex: 1 1 300px; max-width: 600px; min-width: 140px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: box-shadow 0.2s; border: 2px solid transparent; }
        .vid-card video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .vid-card.screen video { transform: scaleX(1); }
        .vid-card.muted-vid video { display: none; }
        .vid-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #1e1e1e; display: none; }
        .vid-card.muted-vid .vid-overlay { display: flex; }
        .vid-overlay img { width: 35%; border-radius: 50%; }
        
        /* ACTIVE SPEAKER GLOW */
        .vid-card.speaking { border-color: #4caf50; box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
        
        /* RAISE HAND */
        .hand-badge { position: absolute; top: 10px; left: 10px; background: #ffca28; color: black; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; display: none; animation: bounce 1s infinite; z-index: 10; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .name-tag { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; }
        .mic-tag { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .mic-tag.off { background: var(--danger); }

        /* CONTROLS */
        #controls-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(15px); padding: 10px 20px; border-radius: 30px; display: flex; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; max-width: 95%; overflow-x: auto; white-space: nowrap; }
        .ctrl-btn { width: 50px; height: 50px; flex-shrink: 0; border-radius: 50%; border: none; background: #3c3c3c; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .ctrl-btn.off { background: var(--danger); }
        .ctrl-btn.active { background: var(--primary); color: black; }
        .ctrl-btn.hangup { background: #ff4444; }

        /* CHAT */
        #chat-panel { position: fixed; right: 20px; bottom: 100px; top: 20px; width: 300px; background: rgba(30,30,30,0.95); backdrop-filter: blur(10px); border-radius: 16px; display: none; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.5); z-index: 150; border: 1px solid #444; }
        #chat-header { padding: 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; font-weight: bold; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { background: #444; padding: 8px 12px; border-radius: 8px; font-size: 14px; max-width: 90%; }
        .chat-msg.mine { background: var(--primary); color: black; align-self: flex-end; }
        .chat-msg-name { font-size: 10px; opacity: 0.7; margin-bottom: 2px; }
        #chat-input-area { padding: 10px; border-top: 1px solid #444; display: flex; gap: 5px; }
        #chat-in { flex: 1; background: #222; border: none; color: white; padding: 8px; border-radius: 6px; outline: none; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1e1e1e; width: 90%; max-width: 400px; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        select { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; margin-bottom: 15px; }

        @media (max-width: 600px) {
            .mobile-hide { display: none; }
            #chat-panel { left: 0; right: 0; top: 0; bottom: 0; width: 100%; border-radius: 0; }
            #controls-bar { bottom: 10px; padding: 8px 15px; }
        }
    </style>
</head>
<body>

    <!-- SCREEN 1: HOME -->
    <div id="home-screen" class="screen">
        <div class="hero-card">
            <h1>GlassMeet</h1>
            <button class="hero-btn" onclick="createNewRoom()">+ –ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</button>
            <div class="input-group">
                <input type="text" id="code-input" class="code-input" placeholder="–∫–æ–¥">
                <button class="join-code-btn" onclick="joinByCode()">‚Üí</button>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: LOBBY -->
    <div id="lobby-screen" class="screen">
        <div class="lobby-container">
            <div class="preview-box">
                <video id="lobby-vid" autoplay playsinline muted></video>
                <div class="preview-avatar" id="lobby-avatar-wrap" style="display:none"><img id="lobby-avatar-img" src=""></div>
                <div class="preview-controls">
                    <button id="l-mic" class="circle-btn" onclick="toggleLobbyMedia('audio')">üéôÔ∏è</button>
                    <button id="l-cam" class="circle-btn" onclick="toggleLobbyMedia('video')">üì∑</button>
                </div>
            </div>
            <input type="text" id="username" class="form-input" placeholder="–í–∞—à–µ –∏–º—è">
            <label style="color:var(--primary); cursor:pointer; font-size:14px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ <input type="file" hidden onchange="uploadAvatar(this)"></label>
            <button class="hero-btn" onclick="enterRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- SCREEN 3: MEETING -->
    <div id="meeting-screen" class="screen">
        <div id="video-grid"></div>

        <!-- Chat Panel -->
        <div id="chat-panel">
            <div id="chat-header">–ß–∞—Ç <span onclick="toggleChat()" style="cursor:pointer">‚úï</span></div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" style="background:var(--primary); border:none; border-radius:6px;">‚û§</button>
            </div>
        </div>

        <div id="controls-bar">
            <button id="btn-mic" class="ctrl-btn" onclick="toggleMic()">üéôÔ∏è</button>
            <button id="btn-cam" class="ctrl-btn" onclick="toggleCam()">üì∑</button>
            <button class="ctrl-btn mobile-hide" onclick="toggleScreen()">üñ•Ô∏è</button>
            <button class="ctrl-btn" onclick="toggleChat()">üí¨</button>
            <button class="ctrl-btn" onclick="raiseHand()">‚úã</button>
            <button class="ctrl-btn" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="ctrl-btn mobile-hide" onclick="sendReaction('üòÇ')">üòÇ</button>
            <button class="ctrl-btn hangup" onclick="hangUp()">üìû</button>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="modal-settings" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <label>–ö–∞–º–µ—Ä–∞</label>
            <select id="sel-cam" onchange="changeDevice('video')"></select>
            <label>–ú–∏–∫—Ä–æ—Ñ–æ–Ω</label>
            <select id="sel-mic" onchange="changeDevice('audio')"></select>
            
            <label style="color:var(--primary)">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞ (–≠—Ñ—Ñ–µ–∫—Ç—ã)</label>
            <select id="sel-voice" onchange="changeVoiceEffect(this.value)">
                <option value="none">–û–±—ã—á–Ω—ã–π</option>
                <option value="robot">–†–æ–±–æ—Ç</option>
                <option value="echo">–≠—Ö–æ (–ó–∞–ª)</option>
                <option value="alien">–ü—Ä–∏—à–µ–ª–µ—Ü</option>
            </select>
            
            <div id="admin-panel" style="display:none; border-top:1px solid #333; margin-top:10px; padding-top:10px">
                <h4 style="color:var(--secondary)">–ê–¥–º–∏–Ω–∫–∞</h4>
                <div id="user-list"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myStream, processedStream; // processed - —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
        let audioCtx, audioSource, audioDest, effectNodes = [];
        let peers = {}, myId, isAdmin = false, currentRoom = "";
        let prefs = { name: '', avatar: `https://api.dicebear.com/7.x/initials/svg?seed=${Date.now()}`, audio: true, video: true, camId: '', micId: '', voiceEffect: 'none' };

        window.onload = () => {
            const saved = localStorage.getItem('gm_prefs');
            if(saved) prefs = {...prefs, ...JSON.parse(saved)};
            document.getElementById('username').value = prefs.name;
            document.getElementById('lobby-avatar-img').src = prefs.avatar;
            document.getElementById('sel-voice').value = prefs.voiceEffect;
            
            const path = window.location.pathname.replace('/', '');
            if(path) { currentRoom=path; showScreen('lobby-screen'); startLobby(); }
            else showScreen('home-screen');
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- AUDIO PROCESSING (VOICE CHANGER & ANALYSIS) ---
        function initAudioContext() {
            if(!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioDest = audioCtx.createMediaStreamDestination();
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function applyVoiceEffect(stream) {
            initAudioContext();
            
            // Cleanup old nodes
            if(audioSource) audioSource.disconnect();
            effectNodes.forEach(n => n.disconnect());
            effectNodes = [];

            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ, stream –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∞ —Å—Ä–∞–∑—É, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º
            if(stream.getAudioTracks().length === 0) return stream;

            audioSource = audioCtx.createMediaStreamSource(stream);
            let lastNode = audioSource;

            if(prefs.voiceEffect === 'robot') {
                const osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = 50; // –ì–ª—É–±–æ–∫–∏–π —Ä–æ–±–æ—Ç
                osc.start();
                
                const gain = audioCtx.createGain();
                osc.connect(gain.gain);
                
                // Ring modulation: Source * Oscillator
                // Simple implementation via gain node modulation
                const ringGain = audioCtx.createGain();
                ringGain.gain.value = 0; // modulated by osc
                lastNode.connect(ringGain);
                osc.connect(ringGain.gain);
                
                lastNode = ringGain;
                effectNodes.push(osc, gain, ringGain);
            } 
            else if(prefs.voiceEffect === 'alien') {
                const osc = audioCtx.createOscillator();
                osc.frequency.value = 10; // Tremolo
                osc.start();
                const gain = audioCtx.createGain();
                osc.connect(gain.gain);
                lastNode.connect(gain);
                lastNode = gain;
                effectNodes.push(osc, gain);
            }
            else if(prefs.voiceEffect === 'echo') {
                const delay = audioCtx.createDelay();
                delay.delayTime.value = 0.4;
                const feedback = audioCtx.createGain();
                feedback.gain.value = 0.4;
                
                lastNode.connect(delay);
                delay.connect(feedback);
                feedback.connect(delay);
                
                const merge = audioCtx.createGain();
                lastNode.connect(merge);
                delay.connect(merge);
                lastNode = merge;
                effectNodes.push(delay, feedback, merge);
            }

            lastNode.connect(audioDest);
            
            // Mix original video track with processed audio track
            const finalStream = new MediaStream();
            finalStream.addTrack(audioDest.stream.getAudioTracks()[0]);
            if(stream.getVideoTracks().length > 0) finalStream.addTrack(stream.getVideoTracks()[0]);
            
            return finalStream;
        }

        function changeVoiceEffect(val) {
            prefs.voiceEffect = val;
            localStorage.setItem('gm_prefs', JSON.stringify(prefs));
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Ç–æ–∫ —Å –Ω–æ–≤—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º
            if(myStream) {
                processedStream = applyVoiceEffect(myStream);
                replaceTracksInPeers(processedStream);
            }
        }

        function monitorAudio(stream, sid) {
            if(!audioCtx || stream.getAudioTracks().length===0) return;
            try {
                const src = audioCtx.createMediaStreamSource(stream);
                const analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64;
                src.connect(analyser);
                
                const data = new Uint8Array(analyser.frequencyBinCount);
                const checkVolume = () => {
                    analyser.getByteFrequencyData(data);
                    let sum = 0;
                    for(let i=0; i<data.length; i++) sum+=data[i];
                    const avg = sum/data.length;
                    
                    const card = document.getElementById(sid === 'local' ? 'card-local' : `card-${sid}`);
                    if(card) {
                        if(avg > 10) card.classList.add('speaking');
                        else card.classList.remove('speaking');
                    }
                    requestAnimationFrame(checkVolume);
                };
                checkVolume();
            } catch(e) { /* ignore cross-origin issues */ }
        }

        // --- LOBBY & JOIN ---
        async function startLobby() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: prefs.micId ? {deviceId: prefs.micId} : true, 
                    video: prefs.camId ? {deviceId: prefs.camId} : true 
                });
                document.getElementById('lobby-vid').srcObject = myStream;
                updateLobbyUI();
                
                // Init Audio Context on user interaction
                document.addEventListener('click', initAudioContext, {once:true});
                
                const devs = await navigator.mediaDevices.enumerateDevices();
                const camSel = document.getElementById('sel-cam');
                const micSel = document.getElementById('sel-mic');
                camSel.innerHTML=''; micSel.innerHTML='';
                devs.forEach(d => {
                    const o = document.createElement('option');
                    o.value=d.deviceId; o.text=d.label||d.kind;
                    if(d.kind==='videoinput') camSel.add(o);
                    if(d.kind==='audioinput') micSel.add(o);
                });
            } catch(e) { alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º"); }
        }

        function toggleLobbyMedia(type) {
            if(type==='video') { prefs.video=!prefs.video; myStream.getVideoTracks()[0].enabled=prefs.video; }
            else { prefs.audio=!prefs.audio; myStream.getAudioTracks()[0].enabled=prefs.audio; }
            updateLobbyUI();
        }

        function updateLobbyUI() {
            document.getElementById('l-cam').classList.toggle('off', !prefs.video);
            document.getElementById('l-mic').classList.toggle('off', !prefs.audio);
            document.getElementById('lobby-vid').style.opacity = prefs.video ? 1 : 0;
            document.getElementById('lobby-avatar-wrap').style.display = prefs.video ? 'none' : 'flex';
        }

        function enterRoom() {
            const name = document.getElementById('username').value.trim();
            if(!name) return alert("–ò–º—è?");
            prefs.name=name; localStorage.setItem('gm_prefs', JSON.stringify(prefs));
            
            showScreen('meeting-screen');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º
            processedStream = applyVoiceEffect(myStream);
            
            addVideoCard('local', processedStream, true, prefs);
            monitorAudio(myStream, 'local'); // Monitor raw stream locally

            socket.emit('join_room', { room: currentRoom, name: prefs.name, avatar: prefs.avatar, video_enabled: prefs.video, audio_enabled: prefs.audio });
        }

        // --- WEBRTC & SOCKET ---
        socket.on('user_joined', u => { initPeer(u.sid, true, u); });
        socket.on('existing_users', list => list.forEach(u => initPeer(u.sid, false, u)));
        socket.on('user_left', d => {
            if(peers[d.sid]) { peers[d.sid].close(); delete peers[d.sid]; }
            const el = document.getElementById(`card-${d.sid}`); if(el) el.remove();
        });
        socket.on('signal', async d => {
            const pc = peers[d.sender];
            if(!pc) return;
            if(d.type==='offer') {
                await pc.setRemoteDescription(d.data);
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);
                socket.emit('signal', {target:d.sender, type:'answer', data:ans});
            } else if(d.type==='answer') await pc.setRemoteDescription(d.data);
            else if(d.type==='candidate') try{await pc.addIceCandidate(d.data)}catch(e){}
        });
        socket.on('user_state_changed', d => {
            const c = document.getElementById(`card-${d.sid}`);
            if(c) {
                if(d.video) c.classList.remove('muted-vid'); else c.classList.add('muted-vid');
                const m = c.querySelector('.mic-tag');
                if(d.audio) m.classList.remove('off'); else m.classList.add('off');
            }
        });
        
        // --- CHAT & HAND ---
        function toggleChat() { 
            const p = document.getElementById('chat-panel');
            p.style.display = p.style.display==='flex' ? 'none' : 'flex';
        }
        function sendChat() {
            const inp = document.getElementById('chat-in');
            const txt = inp.value.trim();
            if(!txt) return;
            socket.emit('chat_message', {room:currentRoom, text:txt});
            inp.value = '';
        }
        socket.on('chat_message', d => {
            const box = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.className = `chat-msg ${d.sid === socket.id ? 'mine' : ''}`;
            msg.innerHTML = `<div class="chat-msg-name">${d.name} ${d.time}</div>${d.text}`;
            box.appendChild(msg);
            box.scrollTop = box.scrollHeight;
            if(document.getElementById('chat-panel').style.display !== 'flex') {
                // notification logic could go here
            }
        });

        function raiseHand() {
            socket.emit('raise_hand', {room: currentRoom});
            playDing();
            showHandBadge('local');
        }
        socket.on('user_hand_raised', d => {
            playDing();
            showHandBadge(d.sid === socket.id ? 'local' : d.sid);
        });
        function showHandBadge(sid) {
            const card = document.getElementById(`card-${sid}`);
            if(!card) return;
            let b = card.querySelector('.hand-badge');
            if(!b) {
                b = document.createElement('div');
                b.className = 'hand-badge';
                b.innerText = '‚úã –ü–æ–¥–Ω—è–ª —Ä—É–∫—É';
                card.appendChild(b);
            }
            b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 5000);
        }
        function playDing() {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = 800;
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1);
            o.start(); o.stop(audioCtx.currentTime+1);
        }

        // --- HELPERS ---
        function initPeer(sid, initiator, info) {
            const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
            peers[sid] = pc;
            processedStream.getTracks().forEach(t => pc.addTrack(t, processedStream));
            pc.onicecandidate = e => e.candidate && socket.emit('signal', {target:sid, type:'candidate', data:e.candidate});
            pc.ontrack = e => {
                if(!document.getElementById(`card-${sid}`)) {
                    addVideoCard(sid, e.streams[0], false, info);
                    monitorAudio(e.streams[0], sid);
                }
            };
            if(initiator) pc.createOffer().then(o => { pc.setLocalDescription(o); socket.emit('signal', {target:sid, type:'offer', data:o}); });
        }

        function addVideoCard(sid, stream, isLocal, info) {
            const div = document.createElement('div');
            div.className = `vid-card ${!info.video_enabled?'muted-vid':''}`; div.id=`card-${sid}`;
            div.innerHTML = `
                <video autoplay playsinline ${isLocal?'muted':''}></video>
                <div class="vid-overlay"><img src="${info.avatar}"></div>
                <div class="name-tag">${info.name}</div>
                <div class="mic-tag ${!info.audio_enabled?'off':''}">${!info.audio_enabled?'üîá':'üéôÔ∏è'}</div>
            `;
            div.querySelector('video').srcObject = stream;
            document.getElementById('video-grid').appendChild(div);
        }

        function replaceTracksInPeers(newStream) {
            const aTrack = newStream.getAudioTracks()[0];
            const vTrack = newStream.getVideoTracks()[0];
            for(let sid in peers) {
                const senders = peers[sid].getSenders();
                const sAudio = senders.find(s=>s.track.kind==='audio');
                if(sAudio && aTrack) sAudio.replaceTrack(aTrack);
                const sVideo = senders.find(s=>s.track.kind==='video');
                if(sVideo && vTrack) sVideo.replaceTrack(vTrack);
            }
        }
        
        function uploadAvatar(i){
            if(i.files[0]){
                const r=new FileReader();
                r.onload=e=>{prefs.avatar=e.target.result;document.getElementById('lobby-avatar-img').src=prefs.avatar;localStorage.setItem('gm_prefs',JSON.stringify(prefs))};
                r.readAsDataURL(i.files[0]);
            }
        }
        async function createNewRoom(){ const res=await fetch('/create_code',{method:'POST'}); const d=await res.json(); window.location.href='/'+d.code; }
        function joinByCode(){ const c=document.getElementById('code-input').value.trim(); if(c) window.location.href='/'+c; }
        function toggleMic(){ 
            prefs.audio=!prefs.audio; 
            if(myStream) myStream.getAudioTracks()[0].enabled=prefs.audio;
            // Also need to toggle processed stream track
            if(processedStream) processedStream.getAudioTracks()[0].enabled=prefs.audio;
            document.getElementById('btn-mic').classList.toggle('off',!prefs.audio);
            socket.emit('state_change',{room:currentRoom, audio:prefs.audio, video:prefs.video});
        }
        function toggleCam(){
            prefs.video=!prefs.video;
            if(myStream) myStream.getVideoTracks()[0].enabled=prefs.video;
            if(processedStream && processedStream.getVideoTracks().length) processedStream.getVideoTracks()[0].enabled=prefs.video;
            document.getElementById('btn-cam').classList.toggle('off',!prefs.video);
            const c=document.getElementById('card-local');
            if(prefs.video) c.classList.remove('muted-vid'); else c.classList.add('muted-vid');
            socket.emit('state_change',{room:currentRoom, audio:prefs.audio, video:prefs.video});
        }
        function openSettings(){document.getElementById('modal-settings').style.display='flex';}
        function hangUp(){window.location.href='/';}
        // Admin functions (shortened)
        socket.on('set_admin', ()=>{isAdmin=true; renderAdmin();});
        function renderAdmin(){
            const box=document.getElementById('user-list'); box.innerHTML=''; document.getElementById('admin-panel').style.display='block';
            // Logic to fetch user list and render buttons (mute/kick/ban)
        }
    </script>
</body>
</html>
